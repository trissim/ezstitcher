# Steps

## Overview

The `Step` class and its subclasses represent individual processing operations in the pipeline architecture. Each step encapsulates a specific operation, such as image processing, position generation, or image stitching.

## Base Step Class

The `Step` class is the base class for all steps in the pipeline architecture. It provides common functionality for loading, processing, and saving images.

### Class Definition

```python
class Step:
    """
    A processing step in a pipeline.

    A Step encapsulates a processing operation that can be applied to images.
    It provides functionality for loading, processing, and saving images.

    Attributes:
        func: The processing function(s) to apply
        variable_components: Components that vary across files (e.g., 'z_index', 'channel')
        group_by: How to group files for processing (e.g., 'channel', 'site')
        input_dir: The input directory
        output_dir: The output directory
        well_filter: Wells to process
        processing_args: Additional arguments to pass to the processing function
        name: Human-readable name for the step
    """

    def __init__(
        self,
        func: ProcessingFunc,
        variable_components: VariableComponents = None,
        group_by: GroupBy = None,
        input_dir: str = None,
        output_dir: str = None,
        well_filter: WellFilter = None,
        processing_args: Dict[str, Any] = None,
        name: str = None
    ):
        """
        Initialize a processing step.

        Args:
            func: The processing function(s) to apply
            variable_components: Components that vary across files
            group_by: How to group files for processing
            input_dir: The input directory
            output_dir: The output directory
            well_filter: Wells to process
            processing_args: Additional arguments to pass to the processing function
            name: Human-readable name for the step
        """
        # ...
```

### Key Responsibilities

#### 1. Image Processing

The step applies processing functions to images:

```python
def _apply_processing(self, images: List[np.ndarray], func: Optional[ProcessingFunc] = None) -> List[np.ndarray]:
    """Apply processing function(s) to a stack (list) of images.

    Note: This method only handles single functions or lists of functions.
    Dictionary mapping of functions to component values is handled by
    prepare_patterns_and_functions before this method is called.

    Args:
        images: List of images (numpy arrays) to process.
        func: Stack-aware processing function or list of functions. Defaults to self.func.

    Returns:
        List of processed images, or the original list if an error occurs.
    """
    # ...
```

#### 2. Image Dimensionality Management

The step ensures that images are 2D:

```python
def _ensure_2d(self, img):
    """Ensure an image is 2D by reducing dimensions if needed."""
    # ...
```

#### 3. Step Execution

The step processes images based on patterns and functions:

```python
def process(self, context: 'ProcessingContext') -> 'ProcessingContext':
    """
    Process the step with the given context.

    This method applies the step's processing function to the input files
    and saves the results to the output directory.

    Args:
        context: The processing context

    Returns:
        The updated processing context
    """
    # ...
```

## Specialized Step Classes

### PositionGenerationStep

The `PositionGenerationStep` is a specialized step for generating position files for stitching.

```python
class PositionGenerationStep(Step):
    """
    A specialized Step for generating positions.

    This step takes processed reference images and generates position files
    for stitching. It stores the positions file in the context for later use.
    """

    def __init__(
        self,
        name: str = "Position Generation",
        input_dir: Optional[Path] = None,
        output_dir: Optional[Path] = None,  # Output directory for positions files
        processing_args: Optional[Dict[str, Any]] = None
    ):
        """
        Initialize a position generation step.

        Args:
            name: Name of the step
            input_dir: Input directory
            output_dir: Output directory (for positions files)
            processing_args: Additional arguments for the processing function
        """
        # ...
```

### ImageStitchingStep

The `ImageStitchingStep` is a specialized step for stitching images using position files.

```python
class ImageStitchingStep(Step):
    """
    A specialized Step for stitching images.

    This step takes processed images and stitches them using the positions file
    generated by a previous PositionGenerationStep.
    """

    def __init__(
        self,
        name: str = "Image Stitching",
        input_dir: Optional[Path] = None,
        positions_dir: Optional[Path] = None,
        output_dir: Optional[Path] = None,
        processing_args: Optional[Dict[str, Any]] = None
    ):
        """
        Initialize an image stitching step.

        Args:
            name: Name of the step
            input_dir: Input directory
            positions_dir: Directory containing position files
            output_dir: Output directory
            processing_args: Additional arguments for the processing function
        """
        # ...
```

## Function Handling

The step architecture supports three patterns for processing functions:

1. **Single Function**: A callable that takes a list of images and returns a list of processed images
2. **List of Functions**: A sequence of functions applied one after another to the images
3. **Dictionary of Functions**: A mapping from component values (like channel numbers) to functions or lists of functions

The relationship between `prepare_patterns_and_functions` and `_apply_processing` is important to understand:

- `prepare_patterns_and_functions` handles the mapping between patterns and functions, ensuring they're in the right format for processing
- `_apply_processing` handles the actual application of functions to images

This separation of concerns allows for flexible processing workflows.

## Example Usage

Here's a simple example of creating and using steps:

```python
from ezstitcher.core.steps import Step, PositionGenerationStep, ImageStitchingStep
from ezstitcher.core.image_preprocessor import ImagePreprocessor as IP
from ezstitcher.core.utils import stack
from pathlib import Path

# Create a basic processing step
processing_step = Step(
    name="Image Enhancement",
    func=[stack(IP.sharpen), IP.stack_percentile_normalize],
    variable_components=['channel'],
    input_dir=Path("path/to/input"),
    output_dir=Path("path/to/output")
)

# Create a position generation step
position_step = PositionGenerationStep(
    name="Generate Positions",
    input_dir=Path("path/to/processed"),
    output_dir=Path("path/to/positions")
)

# Create an image stitching step
stitching_step = ImageStitchingStep(
    name="Stitch Images",
    input_dir=Path("path/to/post_processed"),
    positions_dir=Path("path/to/positions"),
    output_dir=Path("path/to/stitched")
)
```

For more examples, see the [User Guide](../source/user_guide/index.rst) which contains comprehensive usage examples.

## Related Classes

- [PipelineOrchestrator](pipeline_orchestrator.md): Documentation on the PipelineOrchestrator class
- [Pipeline](pipeline.md): Documentation on the Pipeline class
