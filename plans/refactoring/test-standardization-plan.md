# Test Standardization Plan

Status: In Progress  
Progress: 0%  
Last Updated: 2023-07-11  
Dependencies: None

## 1. Problem Analysis

Currently, the ImageXpress and Opera Phenix test files have different test cases and structures:

1. `test_synthetic_imagexpress_refactored_auto.py` has 4 simple test cases:
   - `test_flat_plate_minimal`: Basic flat plate processing
   - `test_zstack_projection_minimal`: Z-stack projection processing
   - `test_zstack_per_plane_minimal`: Z-stack per-plane processing
   - `test_multi_channel_minimal`: Multi-channel reference processing

2. `test_synthetic_opera_phenix_refactored_auto.py` has different test cases with more complex structure:
   - `test_directory_structure_detection`: Tests directory structure detection
   - `test_non_zstack_workflow`: Tests non-Z-stack workflow
   - `test_multi_channel_reference`: Tests multi-channel reference
   - `test_zstack_projection_stitching`: Tests Z-stack projection stitching
   - `test_zstack_per_plane_stitching`: Tests Z-stack per-plane stitching

We need to standardize both files to:
- Have the same 4 test cases
- Use the same test structure
- Only differ in the data generated by the synthetic data generator
- Output test data to `/tests/tests_data/` with a folder for each test file and a subfolder for each test method

## 2. High-Level Solution

1. **Create a standardized Opera Phenix test file**:
   - Use the same 4 test cases as the ImageXpress test file
   - Use the same test structure
   - Only change the `format` parameter in the synthetic data generator

2. **Ensure both test files use the same directory structure**:
   - `/tests/tests_data/{test_file_name}/{test_method_name}/`

3. **Ensure auto-detection works for both microscope types**:
   - Use `microscope_type="auto"` in all test cases
   - Verify that the correct parser is used based on the data format

## 3. Implementation Details

### 3.1 Create Standardized Opera Phenix Test File

```python
# In test_synthetic_opera_phenix_refactored_auto.py
import os
import shutil
import pytest
from pathlib import Path
from ezstitcher.core.main import process_plate_auto
from ezstitcher.tests.generators.generate_synthetic_data import SyntheticMicroscopyGenerator

@pytest.fixture(scope="module")
def base_test_dir():
    """Create base test directory for Opera Phenix tests."""
    base_dir = Path(__file__).parent / "tests_data" / "opera_phenix_refactored_auto"
    
    # Create the directory if it doesn't exist
    base_dir.mkdir(parents=True, exist_ok=True)
    
    yield base_dir
    
    # Uncomment to clean up after tests
    # shutil.rmtree(base_dir)

@pytest.fixture
def test_dir(base_test_dir, request):
    """Create test-specific directory."""
    test_name = request.node.name
    test_dir = base_test_dir / test_name
    
    # Create the directory if it doesn't exist
    test_dir.mkdir(parents=True, exist_ok=True)
    
    print(f"\nSetting up test directory for {test_name}: {test_dir}")
    
    return test_dir

@pytest.fixture
def flat_plate_dir(test_dir):
    """Create synthetic flat plate data."""
    plate_dir = test_dir / "flat_plate"
    generator = SyntheticMicroscopyGenerator(
        output_dir=str(plate_dir),
        grid_size=(2, 2),
        image_size=(256, 256),
        tile_size=(128, 128),
        overlap_percent=10,
        wavelengths=2,
        z_stack_levels=1,
        format="OperaPhenix"  # Only difference from ImageXpress test
    )
    generator.generate_dataset()
    
    # Create a copy of the original data for inspection
    original_dir = test_dir / "flat_plate_original"
    if not original_dir.exists():
        shutil.copytree(plate_dir, original_dir)
    
    return plate_dir

@pytest.fixture
def zstack_plate_dir(test_dir):
    """Create synthetic Z-stack plate data."""
    plate_dir = test_dir / "zstack_plate"
    generator = SyntheticMicroscopyGenerator(
        output_dir=str(plate_dir),
        grid_size=(2, 2),
        image_size=(256, 256),
        tile_size=(128, 128),
        overlap_percent=10,
        wavelengths=2,
        z_stack_levels=5,
        format="OperaPhenix"  # Only difference from ImageXpress test
    )
    generator.generate_dataset()
    
    # Create a copy of the original data for inspection
    original_dir = test_dir / "zstack_plate_original"
    if not original_dir.exists():
        shutil.copytree(plate_dir, original_dir)
    
    return plate_dir

def test_flat_plate_minimal(flat_plate_dir):
    """Test processing a flat plate with minimal configuration."""
    success = process_plate_auto(
        flat_plate_dir,
        microscope_type="auto"  # Use auto-detection
    )
    assert success, "Flat plate processing failed"

def test_zstack_projection_minimal(zstack_plate_dir):
    """Test processing a Z-stack plate with projection."""
    success = process_plate_auto(
        zstack_plate_dir,
        microscope_type="auto",  # Use auto-detection
        **{"z_stack_processor.create_projections": True}
    )
    assert success, "Z-stack projection processing failed"

def test_zstack_per_plane_minimal(zstack_plate_dir):
    """Test processing a Z-stack plate with per-plane stitching."""
    success = process_plate_auto(
        zstack_plate_dir,
        microscope_type="auto",  # Use auto-detection
        **{"z_stack_processor.stitch_all_z_planes": True}
    )
    assert success, "Z-stack per-plane processing failed"

def test_multi_channel_minimal(flat_plate_dir):
    """Test processing a flat plate with multiple reference channels."""
    success = process_plate_auto(
        flat_plate_dir,
        microscope_type="auto",  # Use auto-detection
        **{"reference_channels": ["1", "2"]}
    )
    assert success, "Multi-channel reference processing failed"
```

### 3.2 Update ImageXpress Test File to Use Auto-Detection

```python
# In test_synthetic_imagexpress_refactored_auto.py
# Update the test functions to use auto-detection

def test_flat_plate_minimal(flat_plate_dir):
    """Test processing a flat plate with minimal configuration."""
    success = process_plate_auto(
        flat_plate_dir,
        microscope_type="auto"  # Use auto-detection instead of "ImageXpress"
    )
    assert success, "Flat plate processing failed"

def test_zstack_projection_minimal(zstack_plate_dir):
    """Test processing a Z-stack plate with projection."""
    success = process_plate_auto(
        zstack_plate_dir,
        microscope_type="auto",  # Use auto-detection instead of "ImageXpress"
        **{"z_stack_processor.create_projections": True}
    )
    assert success, "Z-stack projection processing failed"

def test_zstack_per_plane_minimal(zstack_plate_dir):
    """Test processing a Z-stack plate with per-plane stitching."""
    success = process_plate_auto(
        zstack_plate_dir,
        microscope_type="auto",  # Use auto-detection instead of "ImageXpress"
        **{"z_stack_processor.stitch_all_z_planes": True}
    )
    assert success, "Z-stack per-plane processing failed"

def test_multi_channel_minimal(flat_plate_dir):
    """Test processing a flat plate with multiple reference channels."""
    success = process_plate_auto(
        flat_plate_dir,
        microscope_type="auto",  # Use auto-detection instead of "ImageXpress"
        **{"reference_channels": ["1", "2"]}
    )
    assert success, "Multi-channel reference processing failed"
```

## 4. Validation

### 4.1 Unit Tests

1. Run the modified ImageXpress tests to verify they work with auto-detection
2. Run the new Opera Phenix tests to verify they work with auto-detection
3. Verify that the test data is correctly organized in the `/tests/tests_data/` directory

### 4.2 Integration Tests

1. Run all tests to verify that the changes don't break existing functionality
2. Verify that the test data is correctly organized in the `/tests/tests_data/` directory

## 5. Implementation Order

1. Update the ImageXpress test file to use auto-detection
2. Create the standardized Opera Phenix test file
3. Run the tests to verify the changes

## 6. Benefits

1. **Standardized test cases**: Both test files have the same test cases
2. **Consistent test structure**: Both test files use the same test structure
3. **Improved test isolation**: Each test method has its own directory
4. **Better test data management**: Test data is stored in a fixed location for easier inspection
5. **Verified auto-detection**: Tests verify that auto-detection works for both microscope types

## 7. Risks and Mitigations

1. **Risk**: Changes might break existing tests
   **Mitigation**: Run tests after each change to verify functionality

2. **Risk**: Disk space usage might increase
   **Mitigation**: Add cleanup code to remove test data after tests complete

3. **Risk**: Test data might be accidentally committed to version control
   **Mitigation**: Add `/tests/tests_data/` to `.gitignore`

## 8. References

- `tests/test_synthetic_imagexpress_refactored_auto.py`
- `tests/test_synthetic_opera_phenix_refactored_auto.py`
